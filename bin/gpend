#!/usr/bin/env python3
"""
gpend - View latest Gemini reply
"""

import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding
setup_windows_encoding()

from i18n import t

try:
    from gemini_comm import GeminiCommunicator
except ImportError as exc:
    print(f"Import failed: {exc}")
    sys.exit(1)


def _load_cached_reply() -> str | None:
    """Load cached reply from background gask-w process"""
    cache_file = Path.home() / ".cache" / "ccb" / "gemini_last_reply.txt"
    if not cache_file.exists():
        return None
    try:
        content = cache_file.read_text(encoding="utf-8").strip()
        if content:
            cache_file.unlink()  # Clear after reading
            return content
    except Exception:
        pass
    return None


def main() -> int:
    try:
        # First check cached reply from background gask-w
        cached = _load_cached_reply()
        if cached:
            print(f"ü§ñ Gemini reply:")
            print(cached)
            return 0

        comm = GeminiCommunicator()
        output = comm.consume_pending(display=False)
        if output:
            print(output)
        else:
            print(t('no_reply_available', provider='Gemini'))
        return 0
    except Exception as exc:
        print(f"‚ùå {t('execution_failed', error=exc)}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
