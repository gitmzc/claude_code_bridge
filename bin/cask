#!/usr/bin/env python3
"""
cask - Forward message to Codex session
"""
from __future__ import annotations
import json
import os
import sys
from pathlib import Path
from typing import Optional, Tuple

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding
setup_windows_encoding()

from terminal import get_backend_for_session, get_pane_id_from_session


def _usage() -> None:
    print("Usage: cask <message>", file=sys.stderr)


def _load_session() -> Optional[dict]:
    env_pane = os.environ.get("CODEX_WEZTERM_PANE") or os.environ.get("CODEX_ITERM2_PANE")
    if env_pane:
        terminal = "wezterm" if os.environ.get("CODEX_WEZTERM_PANE") else "iterm2"
        return {
            "terminal": terminal,
            "pane_id": env_pane,
            "runtime_dir": os.environ.get("CODEX_RUNTIME_DIR"),
        }

    session_file = Path.cwd() / ".codex-session"
    if not session_file.exists():
        return None
    try:
        data = json.loads(session_file.read_text(encoding="utf-8"))
        if not data.get("active"):
            return None
        return data
    except Exception:
        return None


def _resolve_session() -> Tuple[dict, str]:
    data = _load_session()
    if not data:
        raise RuntimeError("❌ Codex session not found, please run ccb up codex first")
    pane_id = get_pane_id_from_session(data)
    if not pane_id:
        raise RuntimeError("❌ Session config invalid")
    return data, pane_id


def main(argv: list[str]) -> int:
    if len(argv) <= 1:
        _usage()
        return 1

    raw_command = " ".join(argv[1:]).strip()
    if not raw_command:
        _usage()
        return 1

    try:
        data, pane_id = _resolve_session()
        backend = get_backend_for_session(data)
        if not backend:
            raise RuntimeError("❌ Cannot initialize terminal backend")
        if not backend.is_alive(pane_id):
            terminal = data.get("terminal", "wezterm")
            raise RuntimeError(f"❌ {terminal} session not found: {pane_id}\nHint: Please confirm ccb is running")
        backend.send_text(pane_id, raw_command)
        print(f"✅ Sent to Codex ({pane_id})")
        return 0
    except Exception as exc:
        print(exc, file=sys.stderr)
        return 1


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
