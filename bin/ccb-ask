#!/usr/bin/env python3
"""
ccb-ask - Send message to multiple AI providers in parallel
Shortcut for: ccb ask --all --wait
"""
from __future__ import annotations
import os
import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding
setup_windows_encoding()


def main(argv: list[str]) -> int:
    if len(argv) <= 1:
        print("Usage: ccb-ask <message>", file=sys.stderr)
        print("       ccb-ask -p codex,gemini <message>", file=sys.stderr)
        print("", file=sys.stderr)
        print("Options:", file=sys.stderr)
        print("  -p, --providers  Comma-separated providers (default: all)", file=sys.stderr)
        print("  --no-wait        Fire and forget mode", file=sys.stderr)
        print("  -t, --timeout    Timeout in seconds (0=unlimited)", file=sys.stderr)
        return 1

    from broadcast import parallel_ask, format_results
    from output import init_output, is_json, set_output, flush_json

    # Parse arguments
    providers = None
    wait = True
    timeout = 0
    message_parts = []

    i = 1
    while i < len(argv):
        arg = argv[i]
        if arg in ("-p", "--providers") and i + 1 < len(argv):
            providers = [p.strip().lower() for p in argv[i + 1].split(",")]
            i += 2
        elif arg == "--no-wait":
            wait = False
            i += 1
        elif arg in ("-t", "--timeout") and i + 1 < len(argv):
            try:
                timeout = int(argv[i + 1])
            except ValueError:
                print(f"Invalid timeout: {argv[i + 1]}", file=sys.stderr)
                return 1
            i += 2
        elif arg == "--json":
            init_output(json_output=True)
            i += 1
        else:
            message_parts.append(arg)
            i += 1

    message = " ".join(message_parts).strip()
    if not message:
        print("Message cannot be empty", file=sys.stderr)
        return 1

    # Default to all providers
    if providers is None:
        providers = ["codex", "gemini"]

    # Validate providers
    valid_providers = {"codex", "gemini"}
    invalid = set(providers) - valid_providers
    if invalid:
        print(f"Invalid providers: {', '.join(invalid)}", file=sys.stderr)
        return 1

    try:
        results = parallel_ask(
            message=message,
            providers=providers,
            timeout=timeout,
            wait=wait,
        )

        if not results:
            return 1

        # Output
        if is_json():
            set_output("results", results)
            return flush_json(0)

        # Check if stdout is a TTY for color support
        use_color = sys.stdout.isatty()
        print(format_results(results, use_color=use_color))

        # Return non-zero if any provider failed
        if any(not r.get("success") for r in results.values()):
            return 1

        return 0

    except KeyboardInterrupt:
        print("\nInterrupted", file=sys.stderr)
        return 130
    except Exception as exc:
        print(f"Error: {exc}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
